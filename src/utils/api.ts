// src/utils/api.ts
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || "http://localhost:8080";

/** ë¡œê·¸ì¸ */
export const login = async (loginId: string, password: string) => {
  try {
    const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ loginId, password }),
      credentials: "include",
    });

    if (!response.ok) throw new Error("ë¡œê·¸ì¸ ì‹¤íŒ¨");

    const responseData = await response.json();
    if (responseData.code !== 200) throw new Error(responseData.message);

    localStorage.setItem("jwt", responseData.data.accessToken);
    console.log("ì €ì¥ëœ JWT:", responseData.data.accessToken);

    return responseData.data;
  } catch (error) {
    console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
    throw error;
  }
};

/** Access Token ê°±ì‹  (Refresh Token ì‚¬ìš©) */
export const refreshAccessToken = async (): Promise<string | null> => {
  try {
    console.log("ğŸ”„ Access Token ê°±ì‹  ìš”ì²­...");
    const response = await fetch(`${API_BASE_URL}/api/auth/refresh`, {
      method: "POST",
      credentials: "include",
    });

    const responseData = await response.json();
    if (responseData.code !== 200) throw new Error(responseData.message);

    const newAccessToken = responseData.data.accessToken;
    console.log("ìƒˆ Access Token ë°œê¸‰ ì„±ê³µ:", newAccessToken);

    localStorage.setItem("jwt", newAccessToken);
    return newAccessToken;
  } catch (error) {
    console.error("Access Token ê°±ì‹  ì‹¤íŒ¨:", error);
    return null;
  }
};

/** ê³µí†µ API ìš”ì²­ í•¨ìˆ˜ (ëª¨ë“  API ìš”ì²­ì—ì„œ ì‚¬ìš©) */
export const fetchWithAuth = async <T = any>(url: string, options: RequestInit = {}): Promise<T> => {
  let jwtToken = localStorage.getItem("jwt");
  if (!jwtToken) throw new Error("JWT í† í° ì—†ìŒ. ë¡œê·¸ì¸ í•„ìš”");

  const response = await fetch(url, {
    ...options,
    headers: {
      ...options.headers,
      "Authorization": `Bearer ${jwtToken}`,
      "Content-Type": "application/json",
    },
  });

  if (response.status === 401) {
    console.log("â³ Access Token ë§Œë£Œë¨, ê°±ì‹  ì‹œë„...");
    const newAccessToken = await refreshAccessToken();
    if (!newAccessToken) throw new Error("í† í° ê°±ì‹  ì‹¤íŒ¨. ë‹¤ì‹œ ë¡œê·¸ì¸ í•„ìš”.");

    return fetchWithAuth<T>(url, options);
  }

  return response.json() as Promise<T>;
};

/** ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° */
export const getUserInfo = async () => {
  const responseData = await fetchWithAuth(`${API_BASE_URL}/api/user/me`);
  
  console.log("[getUserInfo] ì‘ë‹µ ë°ì´í„°:", responseData);
  return responseData.data;
};

/** ë¡œê·¸ì•„ì›ƒ */
export const logout = async () => {
  await fetchWithAuth(`${API_BASE_URL}/api/auth/logout`, { method: "POST" });
  localStorage.removeItem("jwt");
};
